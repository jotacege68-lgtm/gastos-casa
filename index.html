<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Gastos T+J</title>
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e293b">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --juan: #3b82f6;
            --juan-light: #60a5fa;
            --juan-dark: #2563eb;
            --tania: #ec4899;
            --tania-light: #f472b6;
            --tania-dark: #db2777;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --header-h: 75px;
            --radius: 20px;
            --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f0f4f8; margin: 0; padding-top: calc(var(--header-h) + 20px); 
            color: var(--text-main); min-height: 100vh;
        }

        .tabs { 
            position: fixed; top: 0; width: 100%; background: var(--bg);
            display: flex; height: var(--header-h); z-index: 1000; overflow-x: auto; 
            scrollbar-width: none; backdrop-filter: blur(10px);
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab-btn { 
            flex: 1; min-width: 90px; border: none; background: transparent;
            font-size: 11px; font-weight: 700; color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase; cursor: pointer; padding: 10px 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.3s ease; position: relative;
        }

        .tab-btn.active { color: #ffffff !important; background: rgba(255, 255, 255, 0.15); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 80%; height: 3px; background: white; border-radius: 3px 3px 0 0;
        }

        .container { padding: 16px; display: none; max-width: 500px; margin: auto; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .container.active { display: block; }

        .card { 
            background: var(--card-bg); padding: 24px; border-radius: var(--radius); 
            margin-bottom: 16px; box-shadow: var(--shadow-md); border: 1px solid rgba(0,0,0,0.05);
        }

        label { display: block; margin-bottom: 10px; font-size: 13px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        select, input { 
            width: 100%; padding: 18px 16px; margin-bottom: 16px; border: 2px solid #e2e8f0; 
            border-radius: 14px; font-size: 16px; color: var(--text-main); background: #f8fafc;
        }

        .row { display: flex; gap: 10px; }
        .row div { flex: 1; }

        button { 
            width: 100%; padding: 20px; margin-bottom: 14px; border: none; border-radius: 16px; 
            font-weight: 800; font-size: 16px; cursor: pointer; text-transform: uppercase;
        }
        .btn-juan { background: linear-gradient(135deg, var(--juan-light) 0%, var(--juan-dark) 100%); color: white; }
        .btn-tania { background: linear-gradient(135deg, var(--tania-light) 0%, var(--tania-dark) 100%); color: white; }
        .btn-cerrar { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }

        .historial-item { padding: 18px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .item-pendiente { border-left: 5px solid #cbd5e1 !important; background: #f8fafc !important; opacity: 0.6; }
        .item-jc { border-left: 5px solid #8b5cf6 !important; background: #f5f3ff !important; }
        .item-pagador { font-size: 10px; font-weight: 800; color: #475569; background: #e2e8f0; padding: 6px 12px; border-radius: 20px; }
        .item-nota { font-size: 13px; color: #92400e; background: #fef3c7; padding: 6px 12px; border-radius: 8px; display: inline-block; margin-top: 6px; }

        .total-filtro { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #fbbf24; padding: 28px; border-radius: var(--radius); font-weight: 900; font-size: 28px; text-align: center; margin-bottom: 24px; }
        .subtotal-seccion { background: #f1f5f9; color: var(--text-main); padding: 14px 18px; font-weight: 800; font-size: 14px; border-radius: 12px; margin: 18px 0 10px 0; border-left: 5px solid #cbd5e1; }
        
        .nav-historial, .nav-balance { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: white; padding: 14px; border-radius: 16px; }
        .btn-nav { background: #f1f5f9; color: var(--text-main); padding: 14px 24px; border-radius: 12px; width: auto; font-weight: 700; }

        .balance-item { display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px dashed #e2e8f0; }
        .resultado { margin-top: 24px; padding: 24px; border-radius: 16px; text-align: center; font-weight: 900; font-size: 22px; }
        .debe-juan { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c; border: 2px solid #fca5a5; }
        .debe-tania { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); color: #9d174d; border: 2px solid #f9a8d4; }
    </style>
</head>
<body>

<nav class="tabs">
    <button class="tab-btn active" onclick="showTab('DIARIOS', this)">DIARIO</button>
    <button class="tab-btn" onclick="showTab('MENSUALES', this)">MENSUAL</button>
    <button class="tab-btn" onclick="showTab('JC', this)">SOLO JC</button>
    <button class="tab-btn" onclick="showTab('HISTORIAL', this)">HISTORIAL</button>
    <button class="tab-btn" onclick="showTab('BALANCE', this)">BALANCE</button>
    <button class="tab-btn" onclick="showTab('RESUMENES', this)">REPORTES</button>
</nav>

<div id="DIARIOS" class="container active">
    <div class="card">
        <label>MES DE CARGA</label>
        <div class="row"><div><select id="mes-diarios"></select></div><div><select id="anio-diarios"></select></div></div>
        <label>RUBRO DIARIO (50/50)</label>
        <select id="select-diarios" onchange="toggleNota('diarios')"></select>
        <input type="text" id="nota-diarios" class="nota-input" placeholder="DETALLE / CONCEPTO" style="display:none">
        <input type="number" id="monto-diarios" inputmode="decimal" placeholder="MONTO $">
        <button class="btn-juan" onclick="guardarGasto('DIARIOS', 'JUAN')">PAGÃ“ JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('DIARIOS', 'TANIA')">PAGÃ“ TANIA</button>
    </div>
</div>

<div id="MENSUALES" class="container">
    <div class="card">
        <label>MES DE CARGA</label>
        <div class="row"><div><select id="mes-mensuales"></select></div><div><select id="anio-mensuales"></select></div></div>
        <label>RUBRO MENSUAL (50/50)</label>
        <select id="select-mensuales" onchange="toggleNota('mensuales')"></select>
        <input type="text" id="nota-mensuales" class="nota-input" placeholder="DETALLE / CONCEPTO" style="display:none">
        <label>CUOTAS</label>
        <input type="number" id="cuotas-mensuales" value="1" min="1" max="24">
        <input type="number" id="monto-mensuales" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-juan" onclick="guardarGasto('MENSUALES', 'JUAN')">PAGÃ“ JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('MENSUALES', 'TANIA')">PAGÃ“ TANIA</button>
    </div>
</div>

<div id="JC" class="container">
    <div class="card">
        <label>MES DE CARGA</label>
        <div class="row"><div><select id="mes-jc"></select></div><div><select id="anio-jc"></select></div></div>
        <label>RUBRO JC (DEUDA JUAN)</label>
        <select id="select-jc" onchange="toggleNota('jc')"></select>
        <input type="text" id="nota-jc" class="nota-input" placeholder="DETALLE TARJETA" style="display:none">
        <label>CUOTAS</label>
        <input type="number" id="cuotas-jc" value="1" min="1" max="24">
        <input type="number" id="monto-jc" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-tania" onclick="guardarGasto('JC', 'TANIA')">PAGÃ“ TANIA</button>
    </div>
</div>

<div id="HISTORIAL" class="container">
    <div class="card">
        <label>REPORTE POR PERSONA O RUBRO</label>
        <select id="filtro-rubro" onchange="cargarHistorial()">
            <option value="FILTRO_CASA">GASTOS CASA (DIARIO+MENSUALES)</option>
            <option value="FILTRO_JUAN">PAGÃ“ JUAN (DIARIO + MENSUAL)</option>
            <option value="FILTRO_TANIA">PAGÃ“ TANIA (DIARIO + MENSUAL)</option>
            <option value="FILTRO_COMIDA">GASTOS COMIDA (VARIOS)</option>
            <option value="FILTRO_MENSUALES">SOLO LISTA MENSUAL</option>
            <option value="FILTRO_JC">SOLO LISTA JC</option>
        </select>
    </div>
    <div class="nav-historial"><button class="btn-nav" onclick="cambiarMesHistorial(-1)">â—€</button><h3 id="titulo-mes-historial" style="margin:0">MES</h3><button class="btn-nav" onclick="cambiarMesHistorial(1)">â–¶</button></div>
    <div id="total-acumulado" class="total-filtro">$0</div>
    <div id="lista-historial"></div>
</div>

<div id="BALANCE" class="container">
    <div class="nav-balance"><button class="btn-nav" onclick="cambiarMesBalance(-1)">â—€</button><h3 id="titulo-mes-balance" style="margin:0">MES</h3><button class="btn-nav" onclick="cambiarMesBalance(1)">â–¶</button></div>
    <div class="card" id="resumen-balance"></div>
    <button style="background: #64748b; color: white;" onclick="calcularBalance()">ðŸ”„ ACTUALIZAR</button>
    <button class="btn-cerrar" onclick="cerrarMes()">ðŸ”’ GUARDAR CIERRE DE MES</button>
</div>

<div id="RESUMENES" class="container"><div id="lista-cierres"></div></div>

<script>
    // ConfiguraciÃ³n del Manifesto DinÃ¡mico para PWA (Con tu Logo)
    const manifest = {
      "name": "Gastos T+J", "short_name": "T+J", "start_url": ".", "display": "standalone", "background_color": "#ffffff", "theme_color": "#667eea",
      "icons": [
        { "src": "https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png", "sizes": "192x192", "type": "image/png" },
        { "src": "https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png", "sizes": "512x512", "type": "image/png" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    document.querySelector('head').innerHTML += `<link rel="manifest" href="${manifestURL}">`;

    const firebaseConfig = {
      apiKey: "AIzaSyBDlHjKXf33pCEznyLAmFrTDXVPevrHe9Q",
      authDomain: "gastoscasa-d8bc2.firebaseapp.com",
      databaseURL: "https://gastoscasa-d8bc2-default-rtdb.firebaseio.com",
      projectId: "gastoscasa-d8bc2",
      storageBucket: "gastoscasa-d8bc2.firebasestorage.app",
      messagingSenderId: "749635992986",
      appId: "1:749635992986:web:7916d888f54eb5c3ab0e23",
      measurementId: "G-PHML1K224T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ServerValue = firebase.database.ServerValue;
    
    let fechaBalanceView = new Date();
    let fechaHistorialView = new Date();
    let balanceActual = {};
    const mesesNombres = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

    const listas = {
        diarios: ["AGUA", "AUTO GASTOS", "AVICOLA", "BOLSAS", "CARNICERIA", "CASA VARIOS", "COMBUSTIBLE", "COMIDAS AFUERA", "DENTISTA", "EMPANADAS", "FARMACIA", "FCA. PASTAS", "FERIA PAPEL/CAFE", "FERIA VARIOS", "FERIA VERDURA", "FERRETERIA", "GASTOS ARTIGAS", "GATA COMIDA-PIEDRAS", "LA MOLIENDA", "LAVANDERIA", "PANADERIA", "PANADERIA S/G", "PEAJES", "PESCADERIA", "PIZZA", "PROPINAS", "REGALOS", "SUPERGAS", "SUPERMERCADO", "VARIOS", "VERDULERIA", "VETERINARIA EXTRAS"],
        mensuales: ["A.N.V Juan", "A.N.V. Tania", "ABERTURAS", "CASA VARIOS", "ELECTRICIDAD", "ESPAÃ‘OLA MOVIL", "GASTOS COMUNES DOLARES", "GASTOS COMUNES PESOS", "HBO", "INTERNET", "NETFLIX", "OLLA LEO FA", "SERVICIO FUNEBRE", "VARIOS", "VETERINARIA", "TARJETA BROU REC.", "TARJETA ITAU", "TARJETA OCA", "MANTENIMIENTO AUTO", "CONTRIBUCION INMOBILIARIA", "IMP. PRIMARIA", "IMP. PUERTA", "PATENTE RODADOS", "SEGURO CASA Y AUTO"],
        jc: ["EL TUNEL", "LA MOLIENDA", "CLUB AEBU", "MOVILES", "MEDICAMENTOS ESP.", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"]
    };

    function toggleNota(tipo) {
        const item = document.getElementById(`select-${tipo}`).value;
        const rubrosConNota = ["CASA VARIOS", "REGALOS", "COMIDAS AFUERA", "VARIOS", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"];
        const inputNota = document.getElementById(`nota-${tipo}`);
        if(inputNota) inputNota.style.display = rubrosConNota.includes(item) ? "block" : "none";
    }

    function cargarListas() {
        const hoy = new Date();
        ['diarios','mensuales','jc'].forEach(tab => {
            const mesSel = document.getElementById(`mes-${tab}`);
            const anioSel = document.getElementById(`anio-${tab}`);
            mesesNombres.forEach((m, idx) => {
                const opt = document.createElement('option'); opt.value = idx + 1; opt.innerText = m;
                if(idx === hoy.getMonth()) opt.selected = true;
                mesSel.appendChild(opt);
            });
            for(let a = 2025; a <= 2027; a++) {
                const opt = document.createElement('option'); opt.value = a; opt.innerText = a;
                if(a === hoy.getFullYear()) opt.selected = true;
                anioSel.appendChild(opt);
            }
        });

        const comboHistorial = document.getElementById('filtro-rubro');
        [...listas.diarios, ...listas.mensuales, ...listas.jc].sort().forEach(i => {
            const opt = document.createElement('option'); opt.value = i; opt.innerText = i; comboHistorial.appendChild(opt);
        });
        listas.diarios.sort().forEach(i => document.getElementById('select-diarios').innerHTML += `<option value="${i}">${i}</option>`);
        listas.mensuales.sort().forEach(i => document.getElementById('select-mensuales').innerHTML += `<option value="${i}">${i}</option>`);
        listas.jc.sort().forEach(i => document.getElementById('select-jc').innerHTML += `<option value="${i}">${i}</option>`);
    }

    async function guardarGasto(tipo, pagador) {
        const tab = tipo.toLowerCase();
        const item = document.getElementById(`select-${tab}`).value;
        const notaInput = document.getElementById(`nota-${tab}`);
        const nota = (notaInput && notaInput.style.display !== 'none') ? notaInput.value : "";
        const monto = parseFloat(document.getElementById(`monto-${tab}`).value);
        let cuotas = (tipo === 'MENSUALES' || tipo === 'JC') ? (parseInt(document.getElementById(`cuotas-${tab}`).value) || 1) : 1;
        const mesElegido = parseInt(document.getElementById(`mes-${tab}`).value);
        const anioElegido = parseInt(document.getElementById(`anio-${tab}`).value);
        if (!monto || monto <= 0) return alert("MONTO INVÃLIDO");

        if (tipo === 'MENSUALES' && item !== "CASA VARIOS" && item !== "VARIOS") {
            const snapshot = await db.ref(`gastos_global`).once('value');
            let yaExiste = false;
            snapshot.forEach(child => {
                const g = child.val();
                for (let i = 0; i < cuotas; i++) {
                    let fCheck = new Date(anioElegido, mesElegido - 1 + i, 15);
                    const mesAnioCheck = `${fCheck.getMonth() + 1}-${fCheck.getFullYear()}`;
                    if (g.tipo === 'MENSUALES' && g.item === item && g.mesAnio === mesAnioCheck) yaExiste = true;
                }
            });
            if (yaExiste) { alert(`âš ï¸ ERROR: El rubro "${item}" ya estÃ¡ cargado.`); return; }
        }

        const promesas = [];
        for(let i = 0; i < cuotas; i++) {
            let fF = new Date(anioElegido, mesElegido - 1 + i, 15);
            const mesAnio = `${fF.getMonth() + 1}-${fF.getFullYear()}`;
            const nF = cuotas > 1 ? `${nota} (${i+1}/${cuotas})`.trim() : nota;
            promesas.push(db.ref(`gastos_global`).push({ tipo, item, nota: nF, monto, pagador, fecha: fF.toISOString().split('T')[0], mesAnio, timestamp: ServerValue.TIMESTAMP }));
        }
        Promise.all(promesas).then(() => { alert("âœ… GUARDADO"); document.getElementById(`monto-${tab}`).value = ""; if(notaInput) notaInput.style.display = "none"; refrescarVistas(); });
    }

    function refrescarVistas() {
        if(document.getElementById('HISTORIAL').classList.contains('active')) cargarHistorial();
        if(document.getElementById('BALANCE').classList.contains('active')) calcularBalance();
    }
    function cambiarMesHistorial(n) { fechaHistorialView.setMonth(fechaHistorialView.getMonth() + n); refrescarVistas(); }

    function cargarHistorial() {
        const filtro = document.getElementById('filtro-rubro').value;
        const mesAnio = `${fechaHistorialView.getMonth() + 1}-${fechaHistorialView.getFullYear()}`;
        document.getElementById('titulo-mes-historial').innerText = `${mesesNombres[fechaHistorialView.getMonth()]} ${fechaHistorialView.getFullYear()}`;
        
        db.ref(`gastos_global`).orderByChild('mesAnio').equalTo(mesAnio).once('value', (s) => {
            let gastos = []; s.forEach(c => { let g = c.val(); g.id = c.key; gastos.push(g); });
            let html = ""; let totalGeneral = 0;

            if (filtro === 'FILTRO_JUAN' || filtro === 'FILTRO_TANIA') {
                const persona = filtro === 'FILTRO_JUAN' ? 'JUAN' : 'TANIA';
                const d = gastos.filter(g => g.pagador === persona && g.tipo === 'DIARIOS');
                const m = gastos.filter(g => g.pagador === persona && g.tipo === 'MENSUALES');
                const jc = persona === 'JUAN' ? gastos.filter(g => g.tipo === 'JC') : [];
                html += `<div class="subtotal-seccion"><span>DIARIOS</span><span>$${d.reduce((a,b)=>a+b.monto,0).toFixed(0)}</span></div>` + d.map(g => itemHtml(g)).join('');
                html += `<div class="subtotal-seccion"><span>MENSUALES</span><span>$${m.reduce((a,b)=>a+b.monto,0).toFixed(0)}</span></div>` + m.map(g => itemHtml(g)).join('');
                if(persona === 'JUAN' && jc.length > 0) html += `<div class="subtotal-seccion" style="background:#cbd5e1"><span>INFO JC</span><span>$${jc.reduce((a,b)=>a+b.monto,0).toFixed(0)}</span></div>` + jc.map(g => itemHtml(g)).join('');
                totalGeneral = d.reduce((a,b)=>a+b.monto,0) + m.reduce((a,b)=>a+b.monto,0);
            } else if (filtro === 'FILTRO_CASA') {
                const casa = gastos.filter(g => g.tipo === 'DIARIOS' || g.tipo === 'MENSUALES');
                html = casa.map(g => itemHtml(g)).join('');
                totalGeneral = casa.reduce((acc, g) => acc + g.monto, 0);
            } else if (filtro === 'FILTRO_COMIDA') {
                const rubrosComida = ["CARNICERIA", "SUPERMERCADO", "AVICOLA", "VERDULERIA", "FERIA VERDURA", "PIZZA", "EMPANADAS", "PESCADERIA", "FCA. PASTAS", "COMIDAS AFUERA", "PANADERIA", "PANADERIA S/G"];
                const comida = gastos.filter(g => rubrosComida.includes(g.item));
                html = comida.map(g => itemHtml(g)).join('');
                totalGeneral = comida.reduce((acc, g) => acc + g.monto, 0);
            } else if (filtro === 'FILTRO_MENSUALES') {
                const pagados = gastos.filter(g => g.tipo === 'MENSUALES');
                const rPagados = pagados.map(g => g.item);
                html += pagados.map(g => itemHtml(g)).join('');
                const faltantes = listas.mensuales.filter(r => !rPagados.includes(r)).sort();
                if(faltantes.length > 0) {
                    html += `<div class="subtotal-seccion" style="background:#e2e8f0; color:#64748b;"><span>PENDIENTES DE CARGAR</span></div>`;
                    html += faltantes.map(r => `<div class="historial-item item-pendiente"><div><b>${r}</b></div><div style="text-align:right; color:#94a3b8"><b>$0,0</b></div></div>`).join('');
                }
                totalGeneral = pagados.reduce((acc, g) => acc + g.monto, 0);
            } else {
                gastos.forEach(g => { if ((filtro === 'FILTRO_JC' && g.tipo === 'JC') || (g.item === filtro)) { html += itemHtml(g); totalGeneral += g.monto; } });
            }
            document.getElementById('lista-historial').innerHTML = html;
            document.getElementById('total-acumulado').innerText = `$${totalGeneral.toFixed(0)}`;
        });
    }

    function itemHtml(g) {
        return `<div class="historial-item ${g.tipo === 'JC' ? 'item-jc' : ''}">
            <div><small>${g.fecha.split('-')[2]}/${g.fecha.split('-')[1]}</small><br><b>${g.item}</b><br>${g.nota ? `<span class="item-nota">${g.nota}</span><br>` : ''}<span class="item-pagador">${g.tipo === 'JC' ? 'JC' : 'PAGÃ“: ' + g.pagador}</span></div>
            <div style="text-align:right"><b>$${g.monto.toFixed(0)}</b> <button style="width:auto;padding:5px 10px;background:#fee2e2;color:#ef4444;margin-left:10px" onclick="eliminarGasto('${g.id}')">X</button></div>
        </div>`;
    }

    function eliminarGasto(id) { if(confirm("Â¿Borrar?")) db.ref(`gastos_global/${id}`).remove().then(()=>refrescarVistas()); }
    function cambiarMesBalance(n) { fechaBalanceView.setMonth(fechaBalanceView.getMonth() + n); refrescarVistas(); }
    function calcularBalance() {
        const mesAnio = `${fechaBalanceView.getMonth() + 1}-${fechaBalanceView.getFullYear()}`;
        document.getElementById('titulo-mes-balance').innerText = `${mesesNombres[fechaBalanceView.getMonth()]} ${fechaBalanceView.getFullYear()}`;
        db.ref(`gastos_global`).orderByChild('mesAnio').equalTo(mesAnio).once('value', (s) => {
            let j50 = 0, t50 = 0, totalJC = 0;
            s.forEach(c => { const g = c.val(); if (g.tipo === 'JC') totalJC += g.monto; else if (g.pagador === 'JUAN') j50 += g.monto; else if (g.pagador === 'TANIA') t50 += g.monto; });
            const debe = ((j50 + t50) / 2 - j50) + totalJC;
            balanceActual = { j50, t50, totalJC, deudaJuan: debe, mesAnio };
            document.getElementById('resumen-balance').innerHTML = `<div class="balance-item"><span class="label">Juan:</span> <span class="value">$${j50.toFixed(0)}</span></div><div class="balance-item"><span class="label">Tania:</span> <span class="value">$${t50.toFixed(0)}</span></div><div class="balance-item"><span class="label">JC:</span> <span class="value">$${totalJC.toFixed(0)}</span></div><div class="resultado ${debe > 0 ? 'debe-juan' : 'debe-tania'}">${debe > 0 ? `JUAN ADEUDA A TANIA: $${debe.toFixed(0)}` : `TANIA ADEUDA A JUAN: $${Math.abs(debe).toFixed(0)}`}</div>`;
        });
    }

    function cerrarMes() { if(confirm("Â¿Guardar cierre?")) db.ref(`cierres_mensuales/${balanceActual.mesAnio}`).set({ ...balanceActual, fechaCierre: new Date().toISOString() }).then(() => alert("ðŸ”’ Guardado")); }

    function cargarCierres() {
        db.ref(`cierres_mensuales`).once('value', (s) => {
            let cierresArray = [];
            s.forEach(c => {
                const r = c.val();
                const partes = r.mesAnio.split('-');
                const valorOrden = parseInt(partes[1]) * 100 + parseInt(partes[0]);
                cierresArray.push({ ...r, valorOrden });
            });
            cierresArray.sort((a, b) => b.valorOrden - a.valorOrden);
            let html = "";
            cierresArray.forEach(r => {
                const partes = r.mesAnio.split('-');
                const nombreMes = mesesNombres[parseInt(partes[0]) - 1];
                const etiquetaMes = `${nombreMes} ${partes[1]}`;
                const textoDeuda = r.deudaJuan > 0 ? `JUAN ADEUDA A TANIA` : `TANIA ADEUDA A JUAN`;
                html += `<div class="card">
                    <b style="color:var(--juan-dark)">${etiquetaMes}</b><br>
                    <small>Juan: $${r.j50.toFixed(0)} | Tania: $${r.t50.toFixed(0)} | JC: $${r.totalJC.toFixed(0)}</small><br>
                    <div class="resultado ${r.deudaJuan > 0 ? 'debe-juan' : 'debe-tania'}" style="font-size:14px; padding:10px; margin-top:10px">
                        ${textoDeuda}: $${Math.abs(r.deudaJuan).toFixed(0)}
                    </div>
                </div>`;
            });
            document.getElementById('lista-cierres').innerHTML = html;
        });
    }

    function showTab(id, btn) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active'); refrescarVistas();
        if(id === 'RESUMENES') cargarCierres();
    }
    window.onload = () => { cargarListas(); refrescarVistas(); };
</script>
</body>
</html>
