<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Gastos PRO 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --juan: #2563eb; --tania: #db2777; --bg: #f1f5f9; --header-h: 75px; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding-top: calc(var(--header-h) + 20px); color: #1e293b; }
        .tabs { position: fixed; top: 0; width: 100%; background: #334155; display: flex; height: var(--header-h); box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; overflow-x: auto; white-space: nowrap; }
        .tab-btn { flex: 1; min-width: 90px; border: none; background: none; font-size: 11px; font-weight: 800; color: #cbd5e1; text-transform: uppercase; cursor: pointer; padding: 0 5px; }
        .tab-btn.active { color: white !important; background: var(--juan); border-bottom: 6px solid #1d4ed8; font-weight: 900; }
        .container { padding: 15px; display: none; max-width: 500px; margin: auto; }
        .container.active { display: block; }
        .card { background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        label { display: block; margin-bottom: 10px; font-size: 14px; font-weight: 800; color: #64748b; }
        select, input { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #cbd5e1; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .nota-input { border-color: #fbbf24; background: #fffbeb; font-weight: 600; } 
        button { width: 100%; padding: 18px; margin-bottom: 10px; border: none; border-radius: 15px; font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase; }
        .btn-juan { background: var(--juan); color: white; }
        .btn-tania { background: var(--tania); color: white; }
        .btn-cerrar { background: #10b981; color: white; margin-top: 10px; }
        .historial-item { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
        .item-jc { border-left: 5px solid #1e3a8a; background: #eff6ff; color: #1e3a8a; }
        .item-pagador { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .item-nota { font-size: 13px; color: #b45309; font-style: italic; font-weight: 600; background: #fef3c7; padding: 2px 5px; border-radius: 4px; }
        .total-filtro { background: #1e293b; color: white; padding: 15px; border-radius: 12px; font-weight: 900; text-align: center; margin-bottom: 15px; border: 2px solid #fbbf24; }
        .subtotal-seccion { background: #e2e8f0; color: #1e293b; padding: 8px 15px; font-weight: 900; font-size: 14px; border-radius: 8px; margin: 10px 0; display: flex; justify-content: space-between; }
        .resultado { font-size: 1.1rem; font-weight: 900; text-align: center; margin-top: 15px; padding: 15px; border-radius: 15px; }
        .debe-juan { background: #fee2e2; color: #991b1b; }
        .debe-tania { background: #dcfce7; color: #166534; }
        .mes-separador { background: #334155; color: white; text-align: center; padding: 8px; font-weight: 900; font-size: 13px; border-radius: 8px; margin: 15px 0 10px 0; text-transform: uppercase; }
        .nav-balance { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-nav { background: #64748b; color: white; padding: 10px 15px; border-radius: 10px; width: auto; margin: 0; }
        .input-cuotas { border-color: #10b981; background: #f0fdf4; font-weight: bold; }
    </style>
</head>
<body>

<nav class="tabs">
    <button class="tab-btn active" onclick="showTab('DIARIOS', this)">DIARIO</button>
    <button class="tab-btn" onclick="showTab('MENSUALES', this)">MENSUAL</button>
    <button class="tab-btn" onclick="showTab('JC', this)">SOLO JC</button>
    <button class="tab-btn" onclick="showTab('HISTORIAL', this)">HISTÃ“RICO</button>
    <button class="tab-btn" onclick="showTab('BALANCE', this)">BALANCE</button>
    <button class="tab-btn" onclick="showTab('RESUMENES', this)">RESÃšMENES</button>
</nav>

<div id="DIARIOS" class="container active">
    <div class="card"><label>DIARIO (50/50)</label>
    <select id="select-diarios" onchange="toggleNota('diarios')"></select>
    <input type="text" id="nota-diarios" class="nota-input" placeholder="DETALLE / CONCEPTO" style="display:none">
    <input type="number" id="monto-diarios" inputmode="decimal" placeholder="MONTO $">
    <button class="btn-juan" onclick="guardarGasto('DIARIOS', 'JUAN')">PAGÃ“ JUAN</button>
    <button class="btn-tania" onclick="guardarGasto('DIARIOS', 'TANIA')">PAGÃ“ TANIA</button></div>
</div>

<div id="MENSUALES" class="container">
    <div class="card"><label>MENSUAL (50/50)</label>
    <select id="select-mensuales" onchange="toggleNota('mensuales')"></select>
    <input type="text" id="nota-mensuales" class="nota-input" placeholder="DETALLE / CONCEPTO" style="display:none">
    <label style="color: #059669; font-size: 12px;">Â¿REPETIR MESES? (CUOTAS)</label>
    <input type="number" id="cuotas-mensuales" class="input-cuotas" value="1" min="1" max="24">
    <input type="number" id="monto-mensuales" inputmode="decimal" placeholder="MONTO POR MES $">
    <button class="btn-juan" onclick="guardarGasto('MENSUALES', 'JUAN')">PAGÃ“ JUAN</button>
    <button class="btn-tania" onclick="guardarGasto('MENSUALES', 'TANIA')">PAGÃ“ TANIA</button></div>
</div>

<div id="JC" class="container">
    <div class="card"><label>SOLO JC (DEUDA JUAN)</label>
    <select id="select-jc" onchange="toggleNota('jc')"></select>
    <input type="text" id="nota-jc" class="nota-input" placeholder="DETALLE DE TARJETA" style="display:none">
    <label style="color: #059669; font-size: 12px;">Â¿REPETIR MESES? (CUOTAS)</label>
    <input type="number" id="cuotas-jc" class="input-cuotas" value="1" min="1" max="24">
    <input type="number" id="monto-jc" inputmode="decimal" placeholder="MONTO POR MES $">
    <button class="btn-tania" onclick="guardarGasto('JC', 'TANIA')">PAGÃ“ TANIA</button></div>
</div>

<div id="HISTORIAL" class="container">
    <div class="card">
        <label>REPORTE POR PERSONA O RUBRO</label>
        <select id="filtro-rubro" onchange="cargarHistorial()">
            <option value="TODOS">--- TODOS LOS GASTOS ---</option>
            <option value="FILTRO_JUAN">--- PAGÃ“ JUAN (DIARIO+MENSUAL+JC) ---</option>
            <option value="FILTRO_TANIA">--- PAGÃ“ TANIA (DIARIO+MENSUAL) ---</option>
            <option value="FILTRO_JC">--- SOLO LISTA JC ---</option>
        </select>
        <div class="filtro-group">
            <input type="date" id="fecha-desde" onchange="cargarHistorial()">
            <input type="date" id="fecha-hasta" onchange="cargarHistorial()">
        </div>
    </div>
    <div id="total-acumulado" class="total-filtro">Total: $0</div>
    <div id="lista-historial"></div>
</div>

<div id="BALANCE" class="container">
    <div class="nav-balance">
        <button class="btn-nav" onclick="cambiarMesBalance(-1)">â—€</button>
        <h3 id="titulo-mes-balance" style="margin:0">MES</h3>
        <button class="btn-nav" onclick="cambiarMesBalance(1)">â–¶</button>
    </div>
    <div class="card" id="resumen-balance"></div>
    <button style="background: #64748b; color: white;" onclick="calcularBalance()">ðŸ”„ ACTUALIZAR</button>
    <button class="btn-cerrar" onclick="cerrarMes()">ðŸ”’ GUARDAR CIERRE DE MES</button>
</div>

<div id="RESUMENES" class="container">
    <div id="lista-cierres"></div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBDlHjKXf33pCEznyLAmFrTDXVPevrHe9Q",
      authDomain: "gastoscasa-d8bc2.firebaseapp.com",
      databaseURL: "https://gastoscasa-d8bc2-default-rtdb.firebaseio.com",
      projectId: "gastoscasa-d8bc2",
      storageBucket: "gastoscasa-d8bc2.firebasestorage.app",
      messagingSenderId: "749635992986",
      appId: "1:749635992986:web:7916d888f54eb5c3ab0e23",
      measurementId: "G-PHML1K224T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ServerValue = firebase.database.ServerValue;
    
    let fechaBalanceView = new Date();
    let balanceActual = {};

    const listas = {
        diarios: ["AGUA", "AUTO GASTOS", "AVICOLA", "BOLSAS", "CARNICERIA", "CASA VARIOS", "COMBUSTIBLE", "COMIDAS AFUERA", "DENTISTA", "EMPANADAS", "FARMACIA", "FCA. PASTAS", "FERIA PAPEL/CAFE", "FERIA VARIOS", "FERIA VERDURA", "FERRETERIA", "GASTOS ARTIGAS", "GATA COMIDA-PIEDRAS", "LA MOLIENDA", "LAVANDERIA", "PANADERIA", "PANADERIA S/G", "PEAJES", "PESCADERIA", "PIZZA", "PROPINAS", "REGALOS", "SUPERGAS", "SUPERMERCADO", "VARIOS", "VERDULERIA", "VETERINARIA EXTRAS"],
        mensuales: ["A.N.V Juan", "A.N.V. Tania", "ABERTURAS", "CASA VARIOS", "ELECTRICIDAD", "ESPAÃ‘OLA MOVIL", "GASTOS COMUNES DOLARES", "GASTOS COMUNES PESOS", "HBO", "INTERNET", "NETFLIX", "OLLA LEO FA", "SERVICIO FUNEBRE", "VARIOS", "VETERINARIA", "TARJETA BROU REC.", "TARJETA ITAU", "TARJETA OCA", "MANTENIMIENTO AUTO", "CONTRIBUCION INMOBILIARIA", "IMP. PRIMARIA", "IMP. PUERTA", "PATENTE RODADOS", "SEGURO CASA Y AUTO"],
        jc: ["EL TUNEL", "LA MOLIENDA", "CLUB AEBU", "MOVILES", "MEDICAMENTOS ESP.", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"]
    };

    function toggleNota(tipo) {
        const item = document.getElementById(`select-${tipo}`).value;
        const rubrosConNota = ["CASA VARIOS", "REGALOS", "COMIDAS AFUERA", "VARIOS", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"];
        const inputNota = document.getElementById(`nota-${tipo}`);
        if(inputNota) inputNota.style.display = rubrosConNota.includes(item) ? "block" : "none";
    }

    function cargarListas() {
        const comboHistorial = document.getElementById('filtro-rubro');
        const full = [...listas.diarios, ...listas.mensuales, ...listas.jc].sort();
        full.forEach(i => comboHistorial.innerHTML += `<option value="${i}">${i}</option>`);
        listas.diarios.sort().forEach(i => document.getElementById('select-diarios').innerHTML += `<option value="${i}">${i}</option>`);
        listas.mensuales.sort().forEach(i => document.getElementById('select-mensuales').innerHTML += `<option value="${i}">${i}</option>`);
        listas.jc.sort().forEach(i => document.getElementById('select-jc').innerHTML += `<option value="${i}">${i}</option>`);
    }

    async function guardarGasto(tipo, pagador) {
        const item = document.getElementById(`select-${tipo.toLowerCase()}`).value;
        const notaInput = document.getElementById(`nota-${tipo.toLowerCase()}`);
        const nota = (notaInput && notaInput.style.display !== 'none') ? notaInput.value : "";
        const inputMonto = document.getElementById(`monto-${tipo.toLowerCase()}`);
        const monto = parseFloat(inputMonto.value);
        let cuotas = (tipo === 'MENSUALES' || tipo === 'JC') ? (parseInt(document.getElementById(`cuotas-${tipo.toLowerCase()}`).value) || 1) : 1;
        
        if (!monto || monto <= 0) return alert("MONTO INVÃLIDO");

        // Regla de duplicados solo para fijos mensuales
        if (tipo === 'MENSUALES' && item !== "CASA VARIOS" && item !== "VARIOS") {
            const snapshot = await db.ref(`gastos_global`).once('value');
            let yaExiste = false;
            snapshot.forEach(child => {
                const g = child.val();
                for (let i = 0; i < cuotas; i++) {
                    const fCheck = new Date(); fCheck.setMonth(fCheck.getMonth() + i);
                    const mesAnioCheck = `${fCheck.getMonth() + 1}-${fCheck.getFullYear()}`;
                    if (g.tipo === 'MENSUALES' && g.item === item && g.mesAnio === mesAnioCheck) yaExiste = true;
                }
            });
            if (yaExiste) { alert(`âš ï¸ ERROR: El rubro "${item}" ya estÃ¡ cargado.`); return; }
        }

        const promesas = [];
        const hoy = new Date();
        for(let i = 0; i < cuotas; i++) {
            let fF = new Date(hoy.getFullYear(), hoy.getMonth() + i, (i === 0 ? hoy.getDate() : 15));
            const mesAnio = `${fF.getMonth() + 1}-${fF.getFullYear()}`;
            const nF = cuotas > 1 ? `${nota} (${i+1}/${cuotas})`.trim() : nota;
            promesas.push(db.ref(`gastos_global`).push({ tipo, item, nota: nF, monto, pagador, fecha: fF.toISOString().split('T')[0], mesAnio, timestamp: ServerValue.TIMESTAMP }));
        }
        Promise.all(promesas).then(() => { 
            alert("âœ… GUARDADO"); 
            inputMonto.value = ""; 
            if(notaInput) { notaInput.value = ""; notaInput.style.display = "none"; }
            if(tipo === 'MENSUALES' || tipo === 'JC') document.getElementById(`cuotas-${tipo.toLowerCase()}`).value = "1";
        });
    }

    function cargarHistorial() {
        const filtro = document.getElementById('filtro-rubro').value;
        const desde = document.getElementById('fecha-desde').value;
        const hasta = document.getElementById('fecha-hasta').value;
        
        db.ref(`gastos_global`).orderByChild('fecha').once('value', (s) => {
            let gastos = [];
            s.forEach(c => {
                const g = c.val();
                g.id = c.key;
                if ((!desde || g.fecha >= desde) && (!hasta || g.fecha <= hasta)) {
                    gastos.push(g);
                }
            });

            let html = "";
            let totalGeneral = 0;

            if (filtro === 'FILTRO_JUAN' || filtro === 'FILTRO_TANIA') {
                const persona = filtro === 'FILTRO_JUAN' ? 'JUAN' : 'TANIA';
                const d = gastos.filter(g => g.pagador === persona && g.tipo === 'DIARIOS');
                const m = gastos.filter(g => g.pagador === persona && g.tipo === 'MENSUALES');
                const jc = persona === 'JUAN' ? gastos.filter(g => g.tipo === 'JC') : [];

                const sumD = d.reduce((acc, g) => acc + g.monto, 0);
                const sumM = m.reduce((acc, g) => acc + g.monto, 0);
                const sumJC = jc.reduce((acc, g) => acc + g.monto, 0);

                html += `<div class="subtotal-seccion"><span>LISTA DIARIOS</span><span>$${sumD.toFixed(0)}</span></div>` + d.map(g => itemHtml(g)).join('');
                html += `<div class="subtotal-seccion"><span>LISTA MENSUAL</span><span>$${sumM.toFixed(0)}</span></div>` + m.map(g => itemHtml(g)).join('');
                if(persona === 'JUAN') {
                    html += `<div class="subtotal-seccion"><span>LISTA SOLO JC</span><span>$${sumJC.toFixed(0)}</span></div>` + jc.map(g => itemHtml(g)).join('');
                }
                totalGeneral = sumD + sumM + sumJC;
            } else {
                let ultimoMes = "";
                const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                gastos.forEach(g => {
                    if (filtro === 'TODOS' || (filtro === 'FILTRO_JC' && g.tipo === 'JC') || g.item === filtro) {
                        const f = g.fecha.split('-');
                        const mesActual = `${meses[parseInt(f[1])-1]} ${f[0]}`;
                        if(mesActual !== ultimoMes) {
                            html += `<div class="mes-separador">--- ${mesActual} ---</div>`;
                            ultimoMes = mesActual;
                        }
                        html += itemHtml(g);
                        totalGeneral += g.monto;
                    }
                });
            }
            document.getElementById('lista-historial').innerHTML = html;
            document.getElementById('total-acumulado').innerText = `GRAN TOTAL: $${totalGeneral.toFixed(0)}`;
        });
    }

    function itemHtml(g) {
        const f = g.fecha.split('-');
        const esJC = (g.tipo === 'JC');
        return `<div class="card historial-item ${esJC ? 'item-jc' : ''}" style="margin-bottom:8px; padding:12px;">
            <div><small>${f[2]}/${f[1]}/${f[0]}</small><br><b>${g.item}</b><br>${g.nota ? `<span class="item-nota">${g.nota}</span><br>` : ''}<span class="item-pagador">${esJC ? 'LISTA JC' : 'PAGÃ“: ' + g.pagador}</span></div>
            <div style="text-align:right"><b>$${g.monto}</b> <button style="width:auto;padding:5px 10px;background:#fee2e2;color:#ef4444" onclick="eliminarGasto('${g.id}')">X</button></div>
        </div>`;
    }

    function eliminarGasto(id) { if(confirm("Â¿Borrar?")) db.ref(`gastos_global/${id}`).remove().then(()=>cargarHistorial()); }
    function cambiarMesBalance(n) { fechaBalanceView.setMonth(fechaBalanceView.getMonth() + n); calcularBalance(); }

    function calcularBalance() {
        const meses = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
        const mesAnio = `${fechaBalanceView.getMonth() + 1}-${fechaBalanceView.getFullYear()}`;
        document.getElementById('titulo-mes-balance').innerText = `${meses[fechaBalanceView.getMonth()]} ${fechaBalanceView.getFullYear()}`;
        db.ref(`gastos_global`).orderByChild('mesAnio').equalTo(mesAnio).once('value', (s) => {
            let j50 = 0, t50 = 0, totalJC = 0;
            s.forEach(c => {
                const g = c.val();
                if (g.tipo === 'JC') totalJC += g.monto;
                else if (g.pagador === 'JUAN') j50 += g.monto;
                else if (g.pagador === 'TANIA') t50 += g.monto;
            });
            const deudaJuan = ((j50 + t50) / 2 - j50) + totalJC;
            balanceActual = { j50, t50, totalJC, deudaJuan, mesAnio };
            document.getElementById('resumen-balance').innerHTML = `<div class="balance-item"><span>Juan PagÃ³:</span> <strong>$${j50.toFixed(0)}</strong></div><div class="balance-item"><span>Tania PagÃ³:</span> <strong>$${t50.toFixed(0)}</strong></div><div class="balance-item"><span>Deuda JC:</span> <strong>$${totalJC.toFixed(0)}</strong></div><div class="resultado ${deudaJuan > 0 ? 'debe-juan' : 'debe-tania'}">${deudaJuan > 0 ? `JUAN DEBE A TANIA: $${deudaJuan.toFixed(0)}` : `TANIA DEBE A JUAN: $${Math.abs(deudaJuan).toFixed(0)}`}</div>`;
        });
    }

    function cerrarMes() {
        if(!balanceActual.mesAnio) return alert("Actualiza el balance primero");
        if(confirm("Â¿Guardar cierre?")) db.ref(`cierres_mensuales/${balanceActual.mesAnio}`).set({ ...balanceActual, fechaCierre: new Date().toISOString() }).then(() => alert("ðŸ”’ Guardado"));
    }

    function cargarCierres() {
        db.ref(`cierres_mensuales`).once('value', (s) => {
            let html = "<h3 style='text-align:center'>REPORTES ANTERIORES</h3>";
            s.forEach(c => {
                const r = c.val();
                html += `<div class="card resumen-card"><b>MES: ${r.mesAnio}</b><br>Juan: $${r.j50.toFixed(0)} | Tania: $${r.t50.toFixed(0)} | JC: $${r.totalJC.toFixed(0)}<br><div class="resultado ${r.deudaJuan > 0 ? `debe-juan` : `debe-tania`}" style="font-size:12px">${r.deudaJuan > 0 ? `JUAN DEBIÃ“: $${r.deudaJuan.toFixed(0)}` : `TANIA DEBIÃ“: $${Math.abs(r.deudaJuan).toFixed(0)}`}</div></div>`;
            });
            document.getElementById('lista-cierres').innerHTML = html;
        });
    }

    function showTab(id, btn) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'HISTORIAL') cargarHistorial();
        if(id === 'BALANCE') calcularBalance();
        if(id === 'RESUMENES') cargarCierres();
    }
    window.onload = cargarListas;
</script>
</body>
</html>
