<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Gastos T+J - Premium</title>
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#764ba2">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --juan: #3b82f6; --juan-dark: #2563eb;
            --tania: #ec4899; --tania-dark: #db2777;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff; --text-main: #1e293b;
            --text-muted: #64748b; --header-h: 75px;
            --radius: 20px; --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f0f4f8; margin: 0; padding-top: calc(var(--header-h) + 20px); 
            color: var(--text-main); min-height: 100vh;
        }

        .tabs { 
            position: fixed; top: 0; width: 100%; background: var(--bg);
            display: flex; height: var(--header-h); z-index: 1000; overflow-x: auto;
        }
        .tab-btn { 
            flex: 1; min-width: 80px; border: none; background: transparent;
            font-size: 10px; font-weight: 700; color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase; cursor: pointer; display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        .tab-btn.active { color: #ffffff; background: rgba(255, 255, 255, 0.15); border-bottom: 3px solid white; }

        .container { padding: 16px; display: none; max-width: 500px; margin: auto; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .container.active { display: block; }

        .card { 
            background: var(--card-bg); padding: 20px; border-radius: var(--radius); 
            margin-bottom: 16px; box-shadow: var(--shadow-md);
        }

        label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-muted); }
        select, input { 
            width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #e2e8f0; 
            border-radius: 12px; font-size: 16px; background: #f8fafc;
        }

        button { 
            width: 100%; padding: 18px; margin-bottom: 10px; border: none; border-radius: 14px; 
            font-weight: 800; font-size: 15px; cursor: pointer; text-transform: uppercase;
        }
        .btn-juan { background: linear-gradient(135deg, #60a5fa, #2563eb); color: white; }
        .btn-tania { background: linear-gradient(135deg, #f472b6, #db2777); color: white; }
        
        .historial-item { 
            padding: 15px; border-bottom: 1px solid #f1f5f9; display: flex; 
            justify-content: space-between; align-items: center; background: white; border-radius: 10px; margin-bottom: 5px;
        }
        .item-jc { border-left: 5px solid #8b5cf6; background: #f5f3ff; }
        .item-nota { font-size: 12px; color: #92400e; background: #fef3c7; padding: 4px 8px; border-radius: 5px; }

        .total-filtro { 
            background: #1e293b; color: #fbbf24; padding: 20px; border-radius: var(--radius); 
            font-weight: 900; font-size: 24px; text-align: center; margin-bottom: 20px;
        }
        
        .nav-mes { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px; border-radius: 12px; }
        .btn-nav { width: auto; padding: 10px 20px; margin: 0; background: #e2e8f0; }
    </style>
</head>
<body>

<nav class="tabs">
    <button class="tab-btn active" onclick="showTab('DIARIOS', this)">DIARIO</button>
    <button class="tab-btn" onclick="showTab('MENSUALES', this)">MENSUAL</button>
    <button class="tab-btn" onclick="showTab('JC', this)">JC</button>
    <button class="tab-btn" onclick="showTab('HISTORIAL', this)">HISTORIAL</button>
    <button class="tab-btn" onclick="showTab('BALANCE', this)">BALANCE</button>
    <button class="tab-btn" onclick="showTab('RESUMENES', this)">REPORTES</button>
</nav>

<div id="DIARIOS" class="container active">
    <div class="card">
        <label>MES Y A√ëO</label>
        <div style="display:flex; gap:10px">
            <select id="mes-diarios"></select>
            <select id="anio-diarios"></select>
        </div>
        <label>RUBRO DIARIO (50/50)</label>
        <select id="select-diarios" onchange="toggleNota('diarios')"></select>
        <input type="text" id="nota-diarios" placeholder="DETALLE" style="display:none">
        <input type="number" id="monto-diarios" inputmode="decimal" placeholder="MONTO $">
        <button class="btn-juan" onclick="guardarGasto('DIARIOS', 'JUAN')">PAG√ì JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('DIARIOS', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="MENSUALES" class="container">
    <div class="card">
        <label>RUBRO MENSUAL (50/50)</label>
        <select id="select-mensuales" onchange="toggleNota('mensuales')"></select>
        <input type="text" id="nota-mensuales" placeholder="DETALLE" style="display:none">
        <label>CUOTAS</label>
        <input type="number" id="cuotas-mensuales" value="1" min="1">
        <input type="number" id="monto-mensuales" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-juan" onclick="guardarGasto('MENSUALES', 'JUAN')">PAG√ì JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('MENSUALES', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="JC" class="container">
    <div class="card">
        <label>RUBRO JC (DEUDA JUAN)</label>
        <select id="select-jc" onchange="toggleNota('jc')"></select>
        <input type="text" id="nota-jc" placeholder="DETALLE" style="display:none">
        <label>CUOTAS</label>
        <input type="number" id="cuotas-jc" value="1" min="1">
        <input type="number" id="monto-jc" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-tania" onclick="guardarGasto('JC', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="HISTORIAL" class="container">
    <div class="card">
        <label>FILTRAR POR:</label>
        <select id="filtro-rubro" onchange="cargarHistorial()"></select>
    </div>
    <div class="nav-mes">
        <button class="btn-nav" onclick="cambiarMesHistorial(-1)">‚óÄ</button>
        <h3 id="titulo-mes-historial" style="margin:0">MES</h3>
        <button class="btn-nav" onclick="cambiarMesHistorial(1)">‚ñ∂</button>
    </div>
    <div id="total-acumulado" class="total-filtro">$0</div>
    <div id="lista-historial"></div>
</div>

<div id="BALANCE" class="container">
    <div class="nav-mes">
        <button class="btn-nav" onclick="cambiarMesBalance(-1)">‚óÄ</button>
        <h3 id="titulo-mes-balance" style="margin:0">MES</h3>
        <button class="btn-nav" onclick="cambiarMesBalance(1)">‚ñ∂</button>
    </div>
    <div class="card" id="resumen-balance"></div>
    <button style="background:#10b981; color:white" onclick="cerrarMes()">üîí GUARDAR CIERRE</button>
</div>

<div id="RESUMENES" class="container">
    <h3 style="text-align:center">CIERRES HIST√ìRICOS</h3>
    <div id="lista-cierres"></div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBDlHjKXf33pCEznyLAmFrTDXVPevrHe9Q",
      authDomain: "gastoscasa-d8bc2.firebaseapp.com",
      databaseURL: "https://gastoscasa-d8bc2-default-rtdb.firebaseio.com",
      projectId: "gastoscasa-d8bc2",
      storageBucket: "gastoscasa-d8bc2.firebasestorage.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let fechaH = new Date();
    let fechaB = new Date();
    const meses = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

    const listas = {
        diarios: ["AGUA", "AUTO GASTOS", "AVICOLA", "BOLSAS", "CARNICERIA", "CASA VARIOS", "COMBUSTIBLE", "COMIDAS AFUERA", "DENTISTA", "EMPANADAS", "FARMACIA", "FCA. PASTAS", "FERIA PAPEL/CAFE", "FERIA VARIOS", "FERIA VERDURA", "FERRETERIA", "GASTOS ARTIGAS", "GATA COMIDA-PIEDRAS", "LA MOLIENDA", "LAVANDERIA", "PANADERIA", "PANADERIA S/G", "PEAJES", "PESCADERIA", "PIZZA", "PROPINAS", "REGALOS", "SUPERGAS", "SUPERMERCADO", "VARIOS", "VERDULERIA", "VETERINARIA EXTRAS"],
        mensuales: ["A.N.V Juan", "A.N.V. Tania", "ABERTURAS", "CASA VARIOS", "ELECTRICIDAD", "ESPA√ëOLA MOVIL", "GASTOS COMUNES DOLARES", "GASTOS COMUNES PESOS", "HBO", "INTERNET", "NETFLIX", "OLLA LEO FA", "SERVICIO FUNEBRE", "VARIOS", "VETERINARIA", "TARJETA BROU REC.", "TARJETA ITAU", "TARJETA OCA", "MANTENIMIENTO AUTO", "CONTRIBUCION INMOBILIARIA", "IMP. PRIMARIA", "IMP. PUERTA", "PATENTE RODADOS", "SEGURO CASA Y AUTO"],
        jc: ["EL TUNEL", "LA MOLIENDA", "CLUB AEBU", "MOVILES", "MEDICAMENTOS ESP.", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"]
    };

    function init() {
        const hoy = new Date();
        ['diarios','mensuales','jc'].forEach(t => {
            const mS = document.getElementById(`mes-${t}`) || { appendChild: ()=>{} };
            const aS = document.getElementById(`anio-${t}`) || { appendChild: ()=>{} };
            meses.forEach((m, i) => { const o = document.createElement('option'); o.value = i+1; o.text = m; if(i===hoy.getMonth()) o.selected=true; mS.appendChild(o); });
            [2025, 2026, 2027].forEach(a => { const o = document.createElement('option'); o.value = a; o.text = a; if(a===hoy.getFullYear()) o.selected=true; aS.appendChild(o); });
            listas[t].sort().forEach(item => { document.getElementById(`select-${t}`).innerHTML += `<option value="${item}">${item}</option>`; });
        });

        const fR = document.getElementById('filtro-rubro');
        fR.innerHTML = `<option value="TODO_CASA">GASTOS CASA (DIARIO+MENSUAL)</option>
                        <option value="SOLO_COMIDA">COMIDA (CARNICER√çA, FERIA, SUPER...)</option>
                        <option value="SOLO_MENSUALES">LISTA MENSUAL</option>
                        <option value="PAGO_JUAN">PAG√ì JUAN</option>
                        <option value="PAGO_TANIA">PAG√ì TANIA</option>
                        <option value="FILTRO_JC">SOLO LISTA JC</option>`;
        [...listas.diarios, ...listas.mensuales, ...listas.jc].sort().forEach(i => fR.innerHTML += `<option value="${i}">${i}</option>`);
        
        cargarHistorial();
    }

    function toggleNota(tipo) {
        const item = document.getElementById(`select-${tipo}`).value;
        const notaInput = document.getElementById(`nota-${tipo}`);
        const rubros = ["CASA VARIOS", "REGALOS", "COMIDAS AFUERA", "VARIOS", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"];
        notaInput.style.display = rubros.includes(item) ? "block" : "none";
    }

    function guardarGasto(tipo, pagador) {
        const t = tipo.toLowerCase();
        const item = document.getElementById(`select-${t}`).value;
        const monto = parseFloat(document.getElementById(`monto-${t}`).value);
        const nota = document.getElementById(`nota-${t}`).value;
        const cuotas = parseInt(document.getElementById(`cuotas-${t}`)?.value || 1);
        const mE = parseInt(document.getElementById(`mes-diarios`).value); 
        const aE = parseInt(document.getElementById(`anio-diarios`).value);

        if(!monto) return alert("Pone un monto");

        for(let i=0; i<cuotas; i++){
            let f = new Date(aE, (mE-1) + i, 15);
            let mA = `${f.getMonth()+1}-${f.getFullYear()}`;
            db.ref('gastos_global').push({
                tipo, item, monto, pagador, nota: cuotas > 1 ? `${nota} (${i+1}/${cuotas})` : nota,
                fecha: f.toISOString().split('T')[0], mesAnio: mA
            });
        }
        alert("Guardado!");
        document.getElementById(`monto-${t}`).value = "";
        cargarHistorial();
    }

    function cambiarMesHistorial(n) { fechaH.setMonth(fechaH.getMonth() + n); cargarHistorial(); }
    
    function cargarHistorial() {
        const f = document.getElementById('filtro-rubro').value;
        const mA = `${fechaH.getMonth()+1}-${fechaH.getFullYear()}`;
        document.getElementById('titulo-mes-historial').innerText = `${meses[fechaH.getMonth()]} ${fechaH.getFullYear()}`;

        db.ref('gastos_global').orderByChild('mesAnio').equalTo(mA).once('value', s => {
            let html = ""; let total = 0;
            const rubrosComida = ["CARNICERIA", "AVICOLA", "FERIA VERDURA", "VERDULERIA", "SUPERMERCADO", "PESCADERIA", "PANADERIA", "FCA. PASTAS", "EMPANADAS", "PIZZA"];

            s.forEach(child => {
                const g = child.val();
                let mostrar = false;
                if(f === "TODO_CASA" && g.tipo !== "JC") mostrar = true;
                else if(f === "SOLO_COMIDA" && rubrosComida.includes(g.item)) mostrar = true;
                else if(f === "SOLO_MENSUALES" && g.tipo === "MENSUALES") mostrar = true;
                else if(f === "PAGO_JUAN" && g.pagador === "JUAN" && g.tipo !== "JC") mostrar = true;
                else if(f === "PAGO_TANIA" && g.pagador === "TANIA" && g.tipo !== "JC") mostrar = true;
                else if(f === "FILTRO_JC" && g.tipo === "JC") mostrar = true;
                else if(f === g.item) mostrar = true;

                if(mostrar) {
                    total += g.monto;
                    html += `<div class="historial-item ${g.tipo==='JC'?'item-jc':''}">
                        <div><b>${g.item}</b> <small>(${g.pagador})</small><br>${g.nota?`<span class="item-nota">${g.nota}</span>`:''}</div>
                        <div style="text-align:right"><b>$${g.monto}</b><br><button onclick="borrar('${child.key}')" style="width:auto; padding:2px 8px; background:red; color:white; font-size:10px">X</button></div>
                    </div>`;
                }
            });
            document.getElementById('lista-historial').innerHTML = html;
            document.getElementById('total-acumulado').innerText = `$${total.toFixed(0)}`;
        });
    }

    function borrar(id) { if(confirm("¬øBorrar?")) db.ref(`gastos_global/${id}`).remove().then(()=>cargarHistorial()); }

    function cambiarMesBalance(n) { fechaB.setMonth(fechaB.getMonth() + n); cargarBalance(); }
    
    function cargarBalance() {
        const mA = `${fechaB.getMonth()+1}-${fechaB.getFullYear()}`;
        document.getElementById('titulo-mes-balance').innerText = `${meses[fechaB.getMonth()]} ${fechaB.getFullYear()}`;
        db.ref('gastos_global').orderByChild('mesAnio').equalTo(mA).once('value', s => {
            let j=0, t=0, jc=0;
            s.forEach(c => {
                const g = c.val();
                if(g.tipo === "JC") jc += g.monto;
                else if(g.pagador === "JUAN") j += g.monto;
                else if(g.pagador === "TANIA") t += g.monto;
            });
            const deuda = ((j+t)/2 - j) + jc;
            document.getElementById('resumen-balance').innerHTML = `
                <p>Pag√≥ Juan (50/50): $${j}</p><p>Pag√≥ Tania (50/50): $${t}</p><p>Deuda JC: $${jc}</p>
                <h2 style="color:${deuda>0?'#b91c1c':'#9d174d'}">${deuda>0?'DEBE JUAN: $'+deuda.toFixed(0) : 'DEBE TANIA: $'+Math.abs(deuda).toFixed(0)}</h2>
            `;
            window.tempBalance = { mA, j, t, jc, deuda };
        });
    }

    function cerrarMes() {
        if(confirm("¬øCerrar mes?")) {
            db.ref('cierres_mensuales').push({...window.tempBalance, fechaCierre: new Date().toISOString()})
            .then(() => alert("Mes Cerrado"));
        }
    }

    function cargarCierres() {
        db.ref('cierres_mensuales').once('value', s => {
            let cierres = [];
            s.forEach(c => cierres.push(c.val()));
            // ORDENAR DESCENDENTE (M√°s nuevo arriba)
            cierres.sort((a,b) => {
                let [m1, a1] = a.mA.split('-').map(Number);
                let [m2, a2] = b.mA.split('-').map(Number);
                return (a2 * 12 + m2) - (a1 * 12 + m1);
            });
            let html = "";
            cierres.forEach(r => {
                const [m, a] = r.mA.split('-');
                html += `<div class="card">
                    <b>${meses[m-1]} ${a}</b><br>
                    <small>J: $${r.j} | T: $${r.t} | JC: $${r.jc}</small><br>
                    <b style="color:red">${r.deuda>0?'DEBE JUAN: $'+r.deuda.toFixed(0) : 'DEBE TANIA: $'+Math.abs(r.deuda).toFixed(0)}</b>
                </div>`;
            });
            document.getElementById('lista-cierres').innerHTML = html;
        });
    }

    function showTab(id, btn) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'HISTORIAL') cargarHistorial();
        if(id === 'BALANCE') cargarBalance();
        if(id === 'RESUMENES') cargarCierres();
    }

    window.onload = init;
</script>
</body>
</html>

