<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gastos T+J</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --juan: #3b82f6; --juan-light: #60a5fa; --juan-dark: #2563eb;
            --tania: #ec4899; --tania-light: #f472b6; --tania-dark: #db2777;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --header-h: 75px; --radius: 20px; --shadow-md: 0 4px 20px rgba(0,0,0,0.12);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; margin: 0; padding-top: calc(var(--header-h) + 20px); color: var(--text-main); }
        
        .tabs { position: fixed; top: 0; width: 100%; background: var(--bg); display: flex; height: var(--header-h); z-index: 1000; overflow-x: auto; scrollbar-width: none; backdrop-filter: blur(10px); }
        .tab-btn { flex: 1; min-width: 85px; border: none; background: transparent; font-size: 10px; font-weight: 700; color: rgba(255, 255, 255, 0.7); text-transform: uppercase; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .tab-btn.active { color: #ffffff !important; background: rgba(255, 255, 255, 0.15); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 70%; height: 3px; background: white; border-radius: 3px 3px 0 0; }
        
        .container { padding: 16px; display: none; max-width: 500px; margin: auto; animation: slideUp 0.4s ease; }
        .container.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 16px; box-shadow: var(--shadow-md); border: 1px solid rgba(0,0,0,0.05); }
        label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        select, input { width: 100%; padding: 15px; margin-bottom: 12px; border: 2px solid #e2e8e0; border-radius: 12px; font-size: 16px; background: #f8fafc; color: var(--text-main); }
        
        button { width: 100%; padding: 18px; margin-bottom: 12px; border: none; border-radius: 15px; font-weight: 800; font-size: 15px; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        button:active { transform: scale(0.97); }
        .btn-juan { background: linear-gradient(135deg, var(--juan-light) 0%, var(--juan-dark) 100%); color: white; }
        .btn-tania { background: linear-gradient(135deg, var(--tania-light) 0%, var(--tania-dark) 100%); color: white; }
        
        .historial-item { padding: 15px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .total-filtro { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #fbbf24; padding: 25px; border-radius: var(--radius); font-weight: 900; font-size: 26px; text-align: center; margin-bottom: 20px; }
        .subtotal-seccion { background: #f1f5f9; color: var(--text-main); padding: 12px; font-weight: 800; font-size: 13px; border-radius: 10px; margin: 15px 0 8px 0; border-left: 5px solid #cbd5e1; }
        
        .nav-historial, .nav-balance { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 12px; border-radius: 15px; }
        .btn-nav { background: #f1f5f9; color: var(--text-main); padding: 12px 20px; border-radius: 10px; width: auto; font-weight: 700; margin: 0; border:none; }
        
        .resultado { margin-top: 20px; padding: 20px; border-radius: 15px; text-align: center; font-weight: 900; font-size: 20px; }
        .debe-juan { background: #fee2e2; color: #b91c1c; border: 2px solid #fca5a5; }
        .debe-tania { background: #fce7f3; color: #9d174d; border: 2px solid #f9a8d4; }
    </style>
</head>
<body>

<nav class="tabs">
    <button class="tab-btn active" onclick="showTab('DIARIOS', this)">DIARIO</button>
    <button class="tab-btn" onclick="showTab('MENSUALES', this)">MENSUAL</button>
    <button class="tab-btn" onclick="showTab('JC', this)">SOLO JC</button>
    <button class="tab-btn" onclick="showTab('HISTORIAL', this)">HISTORIAL</button>
    <button class="tab-btn" onclick="showTab('BALANCE', this)">BALANCE</button>
    <button class="tab-btn" onclick="showTab('RESUMENES', this)">REPORTES</button>
</nav>

<div id="DIARIOS" class="container active">
    <div class="card">
        <label>MES DE CARGA</label>
        <div style="display:flex; gap:10px"><div><select id="mes-diarios"></select></div><div style="flex:1"><select id="anio-diarios"></select></div></div>
        <label>RUBRO DIARIO (50/50)</label>
        <select id="select-diarios"></select>
        <input type="number" id="monto-diarios" inputmode="decimal" placeholder="MONTO $">
        <button class="btn-juan" onclick="guardarGasto('DIARIOS', 'JUAN')">PAG√ì JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('DIARIOS', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="MENSUALES" class="container">
    <div class="card">
        <label>MES DE CARGA</label>
        <div style="display:flex; gap:10px"><div><select id="mes-mensuales"></select></div><div style="flex:1"><select id="anio-mensuales"></select></div></div>
        <label>RUBRO MENSUAL (50/50)</label>
        <select id="select-mensuales"></select>
        <label>CUOTAS</label>
        <input type="number" id="cuotas-mensuales" value="1" min="1">
        <input type="number" id="monto-mensuales" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-juan" onclick="guardarGasto('MENSUALES', 'JUAN')">PAG√ì JUAN</button>
        <button class="btn-tania" onclick="guardarGasto('MENSUALES', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="JC" class="container">
    <div class="card">
        <label>MES DE CARGA</label>
        <div style="display:flex; gap:10px"><div><select id="mes-jc"></select></div><div style="flex:1"><select id="anio-jc"></select></div></div>
        <label>RUBRO JC (DEUDA JUAN)</label>
        <select id="select-jc"></select>
        <label>CUOTAS</label>
        <input type="number" id="cuotas-jc" value="1" min="1">
        <input type="number" id="monto-jc" inputmode="decimal" placeholder="MONTO POR MES $">
        <button class="btn-tania" onclick="guardarGasto('JC', 'TANIA')">PAG√ì TANIA</button>
    </div>
</div>

<div id="HISTORIAL" class="container">
    <div class="card">
        <label>FILTRAR POR CATEGOR√çA</label>
        <select id="filtro-rubro" onchange="cargarHistorial()">
            <option value="FILTRO_CASA">GASTOS CASA (DIARIO+MENSUALES)</option>
            <option value="FILTRO_COMIDA">GASTOS COMIDA (VARIOS)</option>
            <option value="FILTRO_MENSUALES">SOLO LISTA MENSUAL</option>
            <option value="FILTRO_JC">SOLO LISTA JC</option>
        </select>
    </div>
    <div class="nav-historial"><button class="btn-nav" onclick="cambiarMesHistorial(-1)">‚óÄ</button><h3 id="titulo-mes-historial" style="margin:0">MES</h3><button class="btn-nav" onclick="cambiarMesHistorial(1)">‚ñ∂</button></div>
    <div id="total-acumulado" class="total-filtro">$0</div>
    <div id="lista-historial"></div>
</div>

<div id="BALANCE" class="container">
    <div class="nav-balance"><button class="btn-nav" onclick="cambiarMesBalance(-1)">‚óÄ</button><h3 id="titulo-mes-balance" style="margin:0">MES</h3><button class="btn-nav" onclick="cambiarMesBalance(1)">‚ñ∂</button></div>
    <div class="card" id="resumen-balance"></div>
    <button style="background: #64748b; color: white;" onclick="calcularBalance()">üîÑ ACTUALIZAR</button>
    <button style="background:#10b981; color:white" onclick="cerrarMes()">üîí GUARDAR CIERRE</button>
</div>

<div id="RESUMENES" class="container"><div id="lista-cierres"></div></div>

<script>
    // MANIFEST DIN√ÅMICO PARA ANDROID (SAMSUNG)
    const manifest = {
        "name": "Gastos T+J",
        "short_name": "T+J",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#764ba2",
        "icons": [
            { "src": "https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
            { "src": "https://i.ibb.co/C5f3W1N/logo-casa-tj-azul.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
        ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    document.querySelector('head').innerHTML += `<link rel="manifest" href="${manifestURL}">`;

    const firebaseConfig = { apiKey: "AIzaSyBDlHjKXf33pCEznyLAmFrTDXVPevrHe9Q", authDomain: "gastoscasa-d8bc2.firebaseapp.com", databaseURL: "https://gastoscasa-d8bc2-default-rtdb.firebaseio.com", projectId: "gastoscasa-d8bc2", storageBucket: "gastoscasa-d8bc2.firebasestorage.app", messagingSenderId: "749635992986", appId: "1:749635992986:web:7916d888f54eb5c3ab0e23" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let fechaBalanceView = new Date(); let fechaHistorialView = new Date();
    const mesesNombres = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
    const listas = {
        diarios: ["AGUA", "CARNICERIA", "SUPERMERCADO", "AVICOLA", "VERDULERIA", "FERIA VERDURA", "PIZZA", "EMPANADAS", "PESCADERIA", "FCA. PASTAS", "COMIDAS AFUERA", "PANADERIA", "PANADERIA S/G", "AUTO GASTOS", "BOLSAS", "CASA VARIOS", "COMBUSTIBLE", "DENTISTA", "FARMACIA", "FERIA PAPEL/CAFE", "FERIA VARIOS", "FERRETERIA", "GASTOS ARTIGAS", "GATA COMIDA-PIEDRAS", "LA MOLIENDA", "LAVANDERIA", "PEAJES", "PROPINAS", "REGALOS", "SUPERGAS", "VARIOS", "VETERINARIA EXTRAS"],
        mensuales: ["A.N.V Juan", "A.N.V. Tania", "ABERTURAS", "CASA VARIOS", "ELECTRICIDAD", "ESPA√ëOLA MOVIL", "GASTOS COMUNES DOLARES", "GASTOS COMUNES PESOS", "HBO", "INTERNET", "NETFLIX", "OLLA LEO FA", "SERVICIO FUNEBRE", "VARIOS", "VETERINARIA", "TARJETA BROU REC.", "TARJETA ITAU", "TARJETA OCA", "MANTENIMIENTO AUTO", "CONTRIBUCION INMOBILIARIA", "IMP. PRIMARIA", "IMP. PUERTA", "PATENTE RODADOS", "SEGURO CASA Y AUTO"],
        jc: ["EL TUNEL", "LA MOLIENDA", "CLUB AEBU", "MOVILES", "MEDICAMENTOS ESP.", "GASTOS OCA", "GASTOS ITAU", "GASTOS SANTANDER"]
    };

    function cargarListas() {
        const hoy = new Date();
        ['diarios','mensuales','jc'].forEach(tab => {
            const mesSel = document.getElementById(`mes-${tab}`); const anioSel = document.getElementById(`anio-${tab}`);
            mesesNombres.forEach((m, idx) => { let opt = new Option(m, idx + 1); if(idx === hoy.getMonth()) opt.selected = true; mesSel.add(opt); });
            [2025, 2026, 2027].forEach(a => { let opt = new Option(a, a); if(a === hoy.getFullYear()) opt.selected = true; anioSel.add(opt); });
            listas[tab].sort().forEach(item => document.getElementById(`select-${tab}`).add(new Option(item, item)));
        });
    }

    async function guardarGasto(tipo, pagador) {
        const tab = tipo.toLowerCase(); const item = document.getElementById(`select-${tab}`).value;
        const monto = parseFloat(document.getElementById(`monto-${tab}`).value);
        let cuotas = (tipo !== 'DIARIOS') ? (parseInt(document.getElementById(`cuotas-${tab}`).value) || 1) : 1;
        const mesElegido = parseInt(document.getElementById(`mes-${tab}`).value); const anioElegido = parseInt(document.getElementById(`anio-${tab}`).value);
        if (!monto || monto <= 0) return alert("MONTO INV√ÅLIDO");
        const promesas = [];
        for(let i = 0; i < cuotas; i++) {
            let f = new Date(anioElegido, mesElegido - 1 + i, 15);
            const mesAnio = `${f.getMonth() + 1}-${f.getFullYear()}`;
            promesas.push(db.ref(`gastos_global`).push({ tipo, item, monto, pagador, fecha: f.toISOString().split('T')[0], mesAnio }));
        }
        await Promise.all(promesas); alert("‚úÖ GUARDADO"); document.getElementById(`monto-${tab}`).value = ""; refrescarVistas();
    }

    function refrescarVistas() { cargarHistorial(); calcularBalance(); }
    function cambiarMesHistorial(n) { fechaHistorialView.setMonth(fechaHistorialView.getMonth() + n); cargarHistorial(); }

    function cargarHistorial() {
        const filtro = document.getElementById('filtro-rubro').value;
        const mesAnio = `${fechaHistorialView.getMonth() + 1}-${fechaHistorialView.getFullYear()}`;
        document.getElementById('titulo-mes-historial').innerText = `${mesesNombres[fechaHistorialView.getMonth()]} ${fechaHistorialView.getFullYear()}`;
        db.ref(`gastos_global`).orderByChild('mesAnio').equalTo(mesAnio).once('value', s => {
            let html = ""; let total = 0;
            const comidaRubros = ["CARNICERIA", "SUPERMERCADO", "AVICOLA", "VERDULERIA", "FERIA VERDURA", "PIZZA", "EMPANADAS", "PESCADERIA", "FCA. PASTAS", "COMIDAS AFUERA", "PANADERIA", "PANADERIA S/G"];
            s.forEach(c => {
                const g = c.val(); let mostrar = false;
                if (filtro === 'FILTRO_CASA' && (g.tipo === 'DIARIOS' || g.tipo === 'MENSUALES')) mostrar = true;
                else if (filtro === 'FILTRO_COMIDA' && comidaRubros.includes(g.item)) mostrar = true;
                else if (filtro === 'FILTRO_MENSUALES' && g.tipo === 'MENSUALES') mostrar = true;
                else if (filtro === 'FILTRO_JC' && g.tipo === 'JC') mostrar = true;
                if (mostrar) {
                    total += g.monto;
                    html += `<div class="historial-item"><div><b>${g.item}</b><br><small>${g.pagador} - ${g.fecha}</small></div><b>$${g.monto}</b></div>`;
                }
            });
            document.getElementById('lista-historial').innerHTML = html || "<center>Sin gastos</center>";
            document.getElementById('total-acumulado').innerText = `$${total.toFixed(0)}`;
        });
    }

    function cambiarMesBalance(n) { fechaBalanceView.setMonth(fechaBalanceView.getMonth() + n); calcularBalance(); }
    function calcularBalance() {
        const mesAnio = `${fechaBalanceView.getMonth() + 1}-${fechaBalanceView.getFullYear()}`;
        document.getElementById('titulo-mes-balance').innerText = `${mesesNombres[fechaBalanceView.getMonth()]} ${fechaBalanceView.getFullYear()}`;
        db.ref(`gastos_global`).orderByChild('mesAnio').equalTo(mesAnio).once('value', s => {
            let j50 = 0, t50 = 0, jc = 0;
            s.forEach(c => { const g = c.val(); if(g.tipo === 'JC') jc += g.monto; else if(g.pagador === 'JUAN') j50 += g.monto; else if(g.pagador === 'TANIA') t50 += g.monto; });
            const debe = ((j50 + t50) / 2 - j50) + jc;
            document.getElementById('resumen-balance').innerHTML = `<div class="balance-item"><span>Juan:</span> <b>$${j50}</b></div><div class="balance-item"><span>Tania:</span> <b>$${t50}</b></div><div class="balance-item"><span>JC:</span> <b>$${jc}</b></div><div class="resultado ${debe > 0 ? 'debe-juan' : 'debe-tania'}">${debe > 0 ? 'JUAN ADEUDA: $' + debe.toFixed(0) : 'TANIA ADEUDA: $' + Math.abs(debe).toFixed(0)}</div>`;
        });
    }

    function cerrarMes() { alert("üîí Cierre guardado"); }
    function cargarCierres() {
        db.ref(`cierres_mensuales`).once('value', s => {
            let cierres = []; s.forEach(c => { let r = c.val(); let p = r.mesAnio.split('-'); r.key = parseInt(p[1])*100 + parseInt(p[0]); cierres.push(r); });
            cierres.sort((a,b) => b.key - a.key);
            let html = cierres.map(r => `<div class="card"><b>${r.mesAnio}</b><br>Juan: $${r.j50} | Tania: $${r.t50}</div>`).join('');
            document.getElementById('lista-cierres').innerHTML = html || "<center>No hay reportes</center>";
        });
    }

    function showTab(id, btn) {
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
        if(id === 'RESUMENES') cargarCierres(); refrescarVistas();
    }
    window.onload = () => { cargarListas(); refrescarVistas(); };
</script>
</body>
</html>
